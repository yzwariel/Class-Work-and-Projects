---
title: "dodge_ts"
author: "Weijie Gao"
date: "11/20/2017"
output:
  word_document: default
---

```{r}
library("TSA")
library(forecast)
library(tseries)
library(fracdiff)
library(tidyverse)
```


```{r}
# read dodge data
dodge <- read.delim('/Users/yzw/Desktop/tsproject/Dogers_data.tsv',stringsAsFactors = FALSE)
str(dodge)
head(dodge,10)
dim(dodge)
```

```{r}
# check the summary for mean price and tickets_listed
summary(dodge$mean_listing_price)
summary(dodge$tickets_listed)
```
```{r}
# separate the raw data into two part
dodge_67 <- subset(dodge,listing_date < "2017-08-01")
dodge_Aug <- subset(dodge, listing_date >= "2017-08-01")
dodge_Aug 
```

```{r}
# check the number of event.
length(unique(dodge_67$event_id))
length(unique(dodge_Aug$event_id))
```

```{r}
# take one event to check time series
dodge_3594065 <-  dodge_67[dodge_67$event_id == 3594065,]
col_name <- dodge_3594065$event_title[1]
Tickets <-  dodge_3594065$tickets_listed
plot.ts(Tickets, xlim=c(0,60),type = "l", main = col_name)
tsdisplay(Tickets,main = col_name)
adf.test(Tickets,k=0)
```

The ADF test returns p-value of 0.01, which is less than the significance level, meaning we can reject the H0 and there is sufficient evidence to suggest this time series is stationary.

```{r}
# Train and holdout split:
ticket_num <- dodge_3594065$tickets_listed
n <- length(ticket_num)
dodge_ticket_train <- ticket_num[1:40]
dodge_ticket_test <- ticket_num[41:n]
```

```{r}
# Prediction: 
# ARIMA 
ticket_forecast <- list()

# Daily Prediction
arima.ticket<- auto.arima(ts(dodge_ticket_train), allowdrift = FALSE, stepwise = FALSE, approximation = FALSE)
summary(arima.ticket)

# residuals for GDP
acf(arima.ticket$residuals,lag=60,main="ACF of residuals for ARIMA(2,1,0) for tickets")

Box.test(arima.ticket$residuals, type="Ljung")
```

From ACF of residuals plot, we can see all spikes are within the boundary, suggesting residuals are not correlated. From Ljung Box test, p-value of 0.8226 is greater than 0.05, suggesting we fail to reject the H0 and there is sufficient evidence to suggest residuals are independent, like white noise. So our model for tickets fits well.

```{r}
# forecast for ARIMA(2,1,0) based on auto.arima() result
d <- n-40
(ticket_forecast$arima <- forecast(arima.ticket,d)$mean[1:d])

# plot forecast
plot(forecast(arima.ticket,d),xlab="Daily",ylab="Tickets Lists")
lines(x = c(41:n), y = dodge_ticket_test, col = "red")
```


```{r}
# ARFIMA 
# Daily Prediction
arfima.ticket <- arfima(ts(dodge_ticket_train), allowdrift = FALSE, stepwise = FALSE, approximation = FALSE)
summary(arfima.ticket)
ticket_forecast$arfima <- forecast(arfima.ticket, d)$mean[1:d]

acf(residuals(garch.ticket)[-1], lag = 300)

# plot forecast
plot(forecast(arfima.ticket,d),xlab="Daily",ylab="Tickets Lists")
lines(x = c(41:n), y = dodge_ticket_test, col = "red")
```

```{r}
# GARCH
garch.ticket <- garch(dodge_ticket_train)
summary(garch.ticket)

ticket_forecast$garch <- (predict(garch.ticket, n.ahead=d)[2:(d+1),1])

ticket_forecast$garch

acf(garch.ticket$residuals[-1],lag = 300)
```

```{r}
# Compare SMAPE of different models
smape <- function(fitted, actual) {
  return(2*mean(abs(fitted - actual) / (abs(fitted) + abs(actual))))
}

(smape.quantity_pred.dec <- mapply(smape, ticket_forecast, list(dodge_ticket_test)))

smape.quantity_pred.dec[which.min(smape.quantity_pred.dec)]
```

```{r}
# check the unique event id
a <-  unique(dodge_67$event_id)
b <-  unique(dodge_Aug$event_id)
```

```{r}
# fit auto arima for each event
ticket.frame <- data.frame()
price.frame <- data.frame()
i = 0
ids <- intersect(a,b)
for (id in ids) {
  i <- i + 1
  entries <- dodge_67 %>% filter(event_id==id)
  tickets <- entries %>% select(tickets_listed) %>% ts()
  price <- entries %>% select(mean_listing_price) %>% ts()
  tickets.fit <- auto.arima(tickets)
  price.fit <- auto.arima(price)
  ticket.frame <- rbind(ticket.frame, c(forecast(tickets.fit, 31)$mean))
  price.frame <- rbind(price.frame, c(forecast(price.fit, 31)$mean))
}
row.names(ticket.frame) <- ids
row.names(price.frame) <- ids
```

```{r}
# rename columns
colnames(ticket.frame) <- seq(as.Date("2017-08-01"), as.Date("2017-08-31"), by="days")
ticket.frame
```

```{r}
# rename columns
colnames(price.frame) <- seq(as.Date("2017-08-01"), as.Date("2017-08-31"), by="days")

price.frame
```

#### Predict tickets_listed with Random Forest
```{r}
# feature extraction
dodge_2 <- dodge_67[,c("taxonomy","listing_date","event_listing_date_id","tickets_listed",
                       "performer_1","performer_2","venue_name")]

head(dodge_2,10)
```

```{r}
library(lubridate)
dodge_2$listing_date <- lubridate::week(ymd(dodge_67$listing_date))
dodge_2$event_listing_date_id <- as.numeric(substr(dodge_67$event_listing_date_id,12,13))

head(dodge_2)
```

```{r}
# change data type into factor
list = c(1,5,6,7)
for (i in list){
  dodge_2[,i] <- as.factor(dodge_2[,i])
}

dodge_2
```

```{r}
library(mlbench)
library(caret)
library(randomForest)
```


```{r}
# split the data into training and test dateset
train_ind <- sample(nrow(dodge_2), size = 0.632 * nrow(dodge_2))
train <- dodge_2[train_ind, ]
test <- dodge_2[-train_ind, ]

# control <- trainControl(method="repeatedcv", number=10, repeats=3,search = "grid")
# metric <- "RMSE"
# mtry <- 2
# tunegrid <- expand.grid(.mtry=mtry)
# modellist <- list()
# for (ntree in c(10,100,500,1000,1500,2000)){
#   set.seed(100)
#   fit <- train(tickets_listed~., data=na.omit(train), method="rf", metric=metric, tunegrid=tunegrid, trControl=control,ntree=ntree)
#   key <- toString(ntree)
#   modellist[[key]] <- fit
# }
# results <- resamples(modellist)
# summary(results)
# dotplot(results)

# Random forest
fit <- randomForest(tickets_listed~., data=na.omit(train),mtry=2,ntree=23)

# summarize the fit
summary(fit)
```

```{r}
# make predictions
predictions <- predict(fit, test)
# summarize accuracy
(RMSE.rf <- sqrt(mean(na.omit((test$tickets_listed - predictions)^2))))
```

```{r}
# make prediction
fit <- randomForest(tickets_listed~., data=na.omit(dodge_2),mtry=2,ntree=23)

dodge_test <- dodge_Aug[,c("taxonomy","listing_date","event_listing_date_id",
                       "performer_1","performer_2","venue_name")]

dodge_test$listing_date <- lubridate::week(ymd(dodge_test$listing_date))
dodge_test$event_listing_date_id <- as.numeric(substr(dodge_test$event_listing_date_id,12,13))

list = c(1,4,5,6)
for (i in list){
  dodge_test[,i] <- as.factor(dodge_test[,i])
}

dodge_test$performer_1 <- factor(dodge_test$performer_1, levels = levels(dodge_2$performer_1))
dodge_test$performer_2 <- factor(dodge_test$performer_2, levels = levels(dodge_2$performer_2))
dodge_test$venue_name <- factor(dodge_test$venue_name , levels = levels(dodge_2$venue_name))

predictions <- predict(fit, dodge_test)

dodge_Aug$tickets_listed <- predictions

head(dodge_Aug)
```

#### Predict mean listing price with Random Forest
```{r}
# feature extraction
dodge_3 <- dodge_67[,c("taxonomy","listing_date","event_listing_date_id","mean_listing_price",
                       "performer_1","performer_2","venue_name")]
head(dodge_3,10)

dodge_3$listing_date <- lubridate::week(ymd(dodge_67$listing_date))
dodge_3$event_listing_date_id <- as.numeric(substr(dodge_67$event_listing_date_id,12,13))

list = c(1,5,6,7)
for (i in list){
  dodge_3[,i] <- as.factor(dodge_3[,i])
}

train_ind <- sample(nrow(dodge_3), size = 0.632 * nrow(dodge_3))
train <- dodge_3[train_ind, ]
test <- dodge_3[-train_ind, ]

# control <- trainControl(method="repeatedcv", number=10, repeats=3,search = "grid")
# metric <- "RMSE"
# mtry <- 2
# tunegrid <- expand.grid(.mtry=mtry)
# modellist <- list()
# for (ntree in c(10,100,500,1000,1500,2000)){
#   set.seed(100)
#   fit <- train(tickets_listed~., data=na.omit(train), method="rf", metric=metric, tunegrid=tunegrid, trControl=control,ntree=ntree)
#   key <- toString(ntree)
#   modellist[[key]] <- fit
# }
# results <- resamples(modellist)
# summary(results)
# dotplot(results)

# Random forest
fit <- randomForest(mean_listing_price~., data=na.omit(train),mtry=2,ntree=55)

# summarize the fit
summary(fit)

plot(fit)
```

```{r}
# make predictions
predictions <- predict(fit, test)
# summarize accuracy
(RMSE.rf <- sqrt(mean(na.omit((test$mean_listing_price - predictions)^2))))
```

```{r}
# make prediction
fit <- randomForest(mean_listing_price~., data=na.omit(dodge_3),mtry=2,ntree=55)

predictions <- predict(fit, dodge_test)

dodge_Aug$mean_listing_price <- predictions

head(dodge_Aug)
```

#### Final prediction results is an ensemble of both time sereis and machine learning results. Further improvement could be made by applying RNN for time series part and gradiend boosting model in machine learning part.



